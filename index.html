<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <title>In Memory of Reb Michel Vishedsky ×¢"×”</title>
    <style>
        :root {
            --primary-color: #faf7f2;
            --secondary-color: #f5f0e6;
            --text-color: #2c2416;
            --border-color: #d1d5db;
            --accent-color: #a68b3b;
            --hover-color: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background-color: var(--primary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Hebrew support */
        [dir="rtl"] {
            text-align: right;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px 0;
            margin-bottom: 40px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
            justify-content: center;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 300;
            color: var(--text-color);
        }

        .bh-text {
            text-align: center;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--accent-color);
        }

        /* Language Toggle */
        .lang-toggle {
            display: flex;
            gap: 10px;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .lang-btn:hover, .lang-btn.active {
            background: var(--hover-color);
        }

        /* Admin Controls - NOW VISIBLE BY DEFAULT */
        .admin-controls {
            display: flex;
            gap: 10px;
        }

        .admin-controls.authenticated {
            display: flex;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-color);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Navigation */
        nav {
            background: var(--secondary-color);
            padding: 15px 0;
            margin-bottom: 40px;
        }

        .nav-menu {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .nav-item {
            color: var(--text-color);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            background: white;
        }

        /* Main Content */
        .main-content {
            min-height: 60vh;
        }

        /* Search and Filter Bar */
        .search-filter-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .tag-filter {
            min-width: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--accent-color);
        }

        .spinner {
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Upload Section */
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .upload-form {
            display: grid;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 500;
            color: var(--text-color);
        }

        input, textarea, select {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .file-input {
            position: relative;
            cursor: pointer;
        }

        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            text-align: center;
            background: var(--primary-color);
            transition: all 0.3s ease;
        }

        .file-input:hover .file-input-label {
            border-color: var(--accent-color);
            background: var(--hover-color);
        }

        /* Memory Grid */
        .memories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
            align-items: start;
        }

        .memory-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .memory-card:hover {
            transform: translateY(-2px);
        }

        .memory-media {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .memory-video {
            width: 100%;
            height: 200px;
        }

        .memory-content {
            padding: 20px;
        }

        .memory-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .memory-description {
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        .memory-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        .memory-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .tag {
            background: var(--secondary-color);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .tag:hover {
            background: var(--accent-color);
            color: white;
        }

        .memory-actions {
            display: none;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .admin-panel.show {
            display: block;
        }

        .admin-login {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .admin-dashboard {
            display: none;
        }

        .admin-dashboard.show {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-color);
        }

        /* Tag Management */
        .tag-manager {
            background: var(--primary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tag-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .existing-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag-removable {
            background: var(--secondary-color);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        /* Video Upload Section */
        .video-upload-section {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 700px;
            margin: 0 auto;
        }

        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--accent-color);
            background: var(--secondary-color);
        }

        .drop-zone-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .drop-zone-text {
            font-size: 18px;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .drop-zone-subtext {
            font-size: 14px;
            color: var(--accent-color);
        }

        .upload-progress {
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--secondary-color);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .upload-status {
            text-align: center;
            color: var(--accent-color);
            font-size: 14px;
        }

        /* Footer */
        footer {
            background: white;
            border-top: 1px solid var(--border-color);
            padding: 30px 0;
            margin-top: 60px;
            text-align: center;
            color: var(--accent-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .logo {
                flex-grow: 0;
            }

            .nav-menu {
                gap: 15px;
            }

            .memories-grid {
                grid-template-columns: 1fr;
            }

            .upload-form {
                padding: 20px;
            }

            .search-filter-bar {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }
        }

        /* Hebrew RTL Styles */
        .hebrew {
            direction: rtl;
            text-align: right;
        }

        .hebrew .header-content {
            flex-direction: row-reverse;
        }

        .hebrew .nav-menu {
            flex-direction: row-reverse;
        }

        /* Success/Error Messages */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div>
                        <div class="bh-text">×‘"×”</div>
                        <h1 id="main-title">In Memory of Reb Michel Vishedsky ×¢"×”</h1>
                    </div>
                </div>
                <div class="lang-toggle">
                    <button class="lang-btn active" onclick="setLanguage('en')">English</button>
                    <button class="lang-btn" onclick="setLanguage('he')">×¢×‘×¨×™×ª</button>
                </div>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <div class="nav-menu">
                <a href="#" class="nav-item active" onclick="showSection('home')" id="nav-home">Home</a>
                <a href="#" class="nav-item" onclick="showSection('memories')" id="nav-memories">Memories</a>
                <a href="#" class="nav-item" onclick="showSection('share')" id="nav-share">Share Memory</a>
                <a href="#" class="nav-item" onclick="showSection('uploadvideo')" id="nav-uploadvideo">Upload Video</a>
                <a href="#" class="nav-item" onclick="showSection('album')" id="nav-album">Photo Album</a>
                <a href="#" class="nav-item" onclick="showSection('about')" id="nav-about">About</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Admin Panel -->
        <div class="admin-panel" id="admin-panel">
            <div class="admin-login" id="admin-login">
                <h2 id="admin-title">Admin Access</h2>
                <div class="form-group">
                    <input type="password" id="admin-password" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">Login</button>
            </div>
            
            <div class="admin-dashboard" id="admin-dashboard">
                <h2>Admin Dashboard</h2>
                
                <!-- Airtable Configuration (Hidden) -->
                <div style="display: none;">
                    <div class="tag-manager" style="margin-bottom: 30px;">
                        <h3>Database Configuration</h3>
                        <div style="display: grid; gap: 15px;">
                            <div class="form-group">
                                <label>Airtable Base ID:</label>
                                <input type="text" id="base-id-input" placeholder="appXXXXXXXXXXXXXX" value="">
                            </div>
                            <div class="form-group">
                                <label>Airtable API Key:</label>
                                <input type="password" id="api-key-input" placeholder="patXXXXXXXXXXXXXX" value="">
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="saveAirtableConfig()">Save Database Config</button>
                                <button class="btn btn-secondary" onclick="testAirtableConnection()">Test Connection</button>
                            </div>
                            <div id="config-status"></div>
                        </div>
                    </div>
                </div>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-memories">-</div>
                        <div class="stat-label">Total Memories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-tags">-</div>
                        <div class="stat-label">Total Tags</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="recent-submissions">-</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>
                
                <div class="tag-manager">
                    <h3>Tag Management</h3>
                    <div class="tag-input-group">
                        <input type="text" id="new-tag-input" placeholder="Add new tag...">
                        <button class="btn btn-primary" onclick="addTag()">Add Tag</button>
                    </div>
                    <div class="existing-tags" id="existing-tags"></div>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="background: #dc3545; color: white;">Clear All Data</button>
                    <button class="btn btn-secondary" onclick="adminLogout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading memories...</p>
        </div>

        <!-- Main Sections -->
        <div class="main-content">
            <!-- Home Section -->
            <div id="home-section" class="section">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 id="welcome-title">In loving memory of Reb Michel Vishedsky ×¢"×”</h2>
                    <p id="welcome-text" style="font-size: 1.1rem; color: var(--accent-color); margin-top: 20px;">
                        A place to share and preserve cherished memories, stories, and moments that celebrate his life and legacy.
                    </p>
                </div>

                <div class="memories-grid" id="recent-memories">
                    <!-- Recent memories will be loaded here -->
                </div>
            </div>

            <!-- Memories Section -->
            <div id="memories-section" class="section" style="display: none;">
                <div style="margin-bottom: 30px;">
                    <h2 id="memories-title">All Memories</h2>
                </div>
                
                <div class="search-filter-bar">
                    <input type="text" class="search-input" id="search-memories" placeholder="Search memories...">
                    <select class="tag-filter" id="tag-filter">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>

                <div class="memories-grid" id="all-memories">
                    <!-- All memories will be loaded here -->
                </div>
            </div>

            <!-- Share Memory Section -->
            <div id="share-section" class="section" style="display: none;">
                <div class="upload-section">
                    <h2 id="share-title" style="text-align: center; margin-bottom: 30px;">Share a Memory</h2>
                    
                    <div id="submission-alert"></div>
                    
                    <form class="upload-form" id="memory-form">
                        <div class="form-group">
                            <label for="memory-type" id="type-label">Type of Memory</label>
                            <select id="memory-type" name="type" required>
                                <option value="">Select type...</option>
                                <option value="photo">Photo</option>
                                <option value="video">Video</option>
                                <option value="youtube">YouTube Video</option>
                                <option value="story">Written Story</option>
                                <option value="voice">Voice Note</option>
                                <option value="document">Document</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="memory-title" id="title-label">Title</label>
                            <input type="text" id="memory-title" name="title">
                        </div>

                        <div class="form-group">
                            <label for="memory-description" id="description-label">Description or Story</label>
                            <p style="font-size: 0.9rem; color: var(--light-text); margin-bottom: 8px;">Use *text* for bold and _text_ for italic</p>
                            <textarea id="memory-description" name="description"></textarea>
                        </div>

                        <div class="form-group" id="file-group">
                            <label id="file-label">Upload File</label>
                            <div class="file-input">
                                <input type="file" id="memory-file" name="file" accept="*/*">
                                <label for="memory-file" class="file-input-label">
                                    <span id="file-text">Click to select or drag file here</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="youtube-group" style="display: none;">
                            <label for="youtube-url" id="youtube-label">YouTube URL</label>
                            <input type="url" id="youtube-url" name="youtube" placeholder="https://www.youtube.com/watch?v=...">
                        </div>

                        <div class="form-group">
                            <label for="submitter-name" id="name-label">Your Name (Optional)</label>
                            <input type="text" id="submitter-name" name="submitter">
                        </div>

                        <div class="form-group" id="voice-group" style="display: none;">
                            <label id="voice-label">Record Voice Note</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                <button type="button" class="btn btn-primary" id="start-record">Start</button>
                                <button type="button" class="btn btn-secondary" id="pause-record" disabled>Pause</button>
                                <button type="button" class="btn btn-danger" id="stop-record" disabled>Stop</button>
                                <button type="button" class="btn btn-secondary" id="play-record" disabled>Play</button>
                                <span id="record-time">0:00</span>
                            </div>
                            <audio id="recorded-audio" controls style="width: 100%; display: none;"></audio>
                            <p id="record-status" style="color: var(--accent-color); font-size: 14px;">Click Start to begin recording</p>
                        </div>

                        <div class="form-group">
                            <label for="submitter-email" id="email-label">Your Email (Optional)</label>
                            <input type="email" id="submitter-email" name="email">
                        </div>

                        <button type="submit" class="btn btn-primary" id="submit-btn">Share Memory</button>
                    </form>
                </div>
            </div>

            <!-- Upload Video Section -->
            <div id="uploadvideo-section" class="section" style="display: none;">
                <div class="video-upload-section">
                    <h2 id="uploadvideo-title" style="text-align: center; margin-bottom: 15px;">Upload Video Memory</h2>
                    <p id="uploadvideo-subtitle" style="text-align: center; color: var(--accent-color); margin-bottom: 40px;">
                        Share longer videos (any size) with us. Your video will be reviewed before appearing on the site.
                    </p>

                    <div id="upload-alert"></div>

                    <!-- Drop Zone -->
                    <div class="drop-zone" id="videoDropZone">
                        <div class="drop-zone-icon">ðŸŽ¬</div>
                        <div class="drop-zone-text" id="drop-text">Drag video here or click to select</div>
                        <div class="drop-zone-subtext" id="drop-subtext">Any video size accepted â€¢ MP4, MOV, AVI, etc.</div>
                        <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
                    </div>

                    <!-- Upload Progress -->
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <div class="upload-status" id="uploadStatus">Preparing upload...</div>
                    </div>

                    <!-- Metadata Form -->
                    <div id="videoMetadataForm" style="display: none;">
                        <div class="form-group">
                            <label for="video-title" id="video-title-label">Video Title *</label>
                            <input type="text" id="video-title" placeholder="e.g., Birthday celebration 2020" required>
                        </div>

                        <div class="form-group">
                            <label for="video-description" id="video-description-label">Description</label>
                            <textarea id="video-description" placeholder="Tell us about this video..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="video-submitter" id="video-submitter-label">Your Name (Optional)</label>
                            <input type="text" id="video-submitter" placeholder="Anonymous">
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button class="btn btn-primary" id="submitVideoBtn" style="flex: 1;">Submit Video</button>
                            <button class="btn btn-secondary" id="cancelVideoBtn">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About Section -->
            <div id="about-section" class="section" style="display: none;">
                <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h2 id="about-title">About Reb Michel Vishedsky ×¢"×”</h2>
                    <div id="about-content">
                        <p id="about-content-p1">This website is dedicated to preserving and sharing the precious memories of Reb Michel Vishedsky ×¢"×”.</p>
                        <p id="about-content-p2">Here, family, friends, and all those whose lives he touched can share photos, videos, stories, and memories that celebrate his life, teachings, and the impact he had, and continues to have, on all of us.</p>
                        <p id="about-content-p3">Every memory shared here contributes to keeping his legacy alive for future generations.</p>
                    </div>
                </div>
            </div>

            <div id="album-section" class="section" style="display: none;">
                <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 id="album-title" style="margin-bottom: 20px;">Family Photo Album</h2>
                    <p id="album-description" style="color: var(--accent-color); margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        A collection of cherished photos and videos from family and friends. Click below to view and contribute to the shared album.
                    </p>
                    <a href="https://photos.app.goo.gl/88gcNGT7uwxmfRFP8" 
                        target="_blank" 
                        class="btn btn-primary" 
                        style="font-size: 18px; padding: 15px 40px; display: inline-block;">
                        Open Family Photo Album
                    </a>
                    <p style="margin-top: 25px; font-size: 14px; color: var(--accent-color);">
                        Family members can add photos directly in Google Photos
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Memory Detail Modal -->
    <div class="modal" id="memory-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modal-title">Memory Details</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div id="modal-content">
                <!-- Memory details will be loaded here -->
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="shareCurrentMemory()" id="share-btn">Share This Memory</button>
            </div>
        </div>
    </div>

    <!-- Edit Memory Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Edit Memory</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <form id="edit-memory-form">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="edit-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-description" required></textarea>
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="edit-tags" placeholder="family, teaching, celebration">
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
    <div class="container">
        <p id="footer-text">In loving memory of Reb Michel Vishedsky ×¢"×”</p>
        <p id="contact-text">Contact: rebmichelvishedsky@gmail.com</p>
        <p style="margin-top: 10px;">
            <a href="#" onclick="showAdminPanel(); return false;" style="font-size: 9px; color: #d1d5db; text-decoration: none; opacity: 0.3;">â€¢</a>
        </p>
    </div>
    </footer>
    
    <script>
    // ============================================
    // CLOUDINARY CONFIGURATION
    // ============================================
    const CLOUDINARY_CONFIG = {
        cloudName: 'deiauee2m', 
        uploadPreset: 'memorial_uploads',
    };

    // ============================================
    // AIRTABLE CONFIGURATION
    // ============================================
    const AIRTABLE_CONFIG = {
        baseId: '',
        tableName: 'Memories',
        apiKey: '',
    };

    const VIDEO_UPLOAD_URL = 'https://reb-michel-video.onrender.com/upload';

    // Language system
    const translations = {
        en: {
            'main-title': 'In Memory of Reb Michel Vishedsky ×¢"×”',
            'admin-btn': 'Admin',
            'nav-home': 'Home',
            'nav-memories': 'Memories',
            'nav-share': 'Share Memory',
            'nav-uploadvideo': 'Upload Video',
            'nav-about': 'About',
            'nav-album': 'Photo Album',
            'welcome-title': 'In loving memory of Reb Michel Vishedsky ×¢"×”',
            'welcome-text': 'A place to share and preserve cherished memories, stories, and moments that celebrate his life and legacy.',
            'memories-title': 'All Memories',
            'share-title': 'Share a Memory',
            'type-label': 'Type of Memory',
            'title-label': 'Title',
            'description-label': 'Description or Story',
            'file-label': 'Upload File',
            'file-text': 'Click to select or drag file here',
            'youtube-label': 'YouTube URL',
            'name-label': 'Your Name (Optional)',
            'email-label': 'Your Email (Optional)',
            'album-title': 'Family Photo Album',
            'album-description': 'A collection of cherished photos and videos from family and friends.',
            'submit-btn': 'Share Memory',
            'about-title': 'About Reb Michel Vishedsky ×¢"×”',
            'about-content-p1': 'This website is dedicated to preserving and sharing the precious memories of Reb Michel Vishedsky ×¢"×”.',
            'about-content-p2': 'Here, family, friends, and all those whose lives he touched can share photos, videos, stories, and memories that celebrate his life, teachings, and the impact he had, and continues to have, on all of us.',
            'about-content-p3': 'Every memory shared here contributes to keeping his legacy alive for future generations.',
            'footer-text': 'In loving memory of Reb Michel Vishedsky ×¢"×”',
            'contact-text': 'Contact: rebmichelvishedsky@gmail.com',
            'uploadvideo-title': 'Upload Video Memory',
            'uploadvideo-subtitle': 'Share longer videos (any size) with us. Your video will be reviewed before appearing on the site.',
            'video-title-label': 'Video Title *',
            'video-description-label': 'Description',
            'video-submitter-label': 'Your Name (Optional)',
        },
        he: {
            'main-title': '×œ×–×›×¨ ×”×¨×‘ ×ž×™×›×œ ×•×™×©×¦×§×™ ×¢"×”',
            'admin-btn': '×ž× ×”×œ',
            'nav-home': '×‘×™×ª',
            'nav-memories': '×–×›×¨×•× ×•×ª',
            'nav-share': '×©×ª×£ ×–×›×¨×•×Ÿ',
            'nav-uploadvideo': '×”×¢×œ×” ×•×™×“××•',
            'nav-about': '××•×“×•×ª',
            'nav-album': '××œ×‘×•× ×ª×ž×•× ×•×ª',
            'welcome-title': '×œ×–×›×¨ ×”×¨×‘ ×ž×™×›×œ ×•×™×©×¦×§×™ ×¢"×”',
            'welcome-text': '×ž×§×•× ×œ×©×ª×£ ×•×œ×©×ž×¨ ×–×›×¨×•× ×•×ª ×™×§×¨×™×, ×¡×™×¤×•×¨×™× ×•×¨×’×¢×™× ×©×—×•×’×’×™× ××ª ×—×™×™×• ×•×ž×•×¨×©×ª×•.',
            'memories-title': '×›×œ ×”×–×›×¨×•× ×•×ª',
            'share-title': '×©×ª×£ ×–×›×¨×•×Ÿ',
            'type-label': '×¡×•×’ ×”×–×›×¨×•×Ÿ',
            'title-label': '×›×•×ª×¨×ª',
            'description-label': '×ª×™××•×¨ ××• ×¡×™×¤×•×¨',
            'file-label': '×”×¢×œ×” ×§×•×‘×¥',
            'file-text': '×œ×—×¥ ×œ×‘×—×™×¨×” ××• ×’×¨×•×¨ ×§×•×‘×¥ ×›××Ÿ',
            'youtube-label': '×§×™×©×•×¨ ×™×•×˜×™×•×‘',
            'name-label': '×©×ž×š (××•×¤×¦×™×•× ×œ×™)',
            'email-label': '×”××™×ž×™×™×œ ×©×œ×š (××•×¤×¦×™×•× ×œ×™)',
            'album-title': '××œ×‘×•× ×ª×ž×•× ×•×ª ×ž×©×¤×—×ª×™',
            'album-description': '××•×¡×£ ×©×œ ×ª×ž×•× ×•×ª ×•×¡×¨×˜×•× ×™× ×™×§×¨×™× ×ž×ž×©×¤×—×” ×•×—×‘×¨×™×.',
            'submit-btn': '×©×ª×£ ×–×›×¨×•×Ÿ',
            'about-title': '××•×“×•×ª ×”×¨×‘ ×ž×™×›×œ ×•×™×©×¦×§×™ ×¢"×”',
            'about-content-p1': '××ª×¨ ×”× ×¦×—×” ×–×” ×ž×•×§×“×© ×œ×©×™×ž×•×¨ ×•×©×™×ª×•×£ ×”×–×™×›×¨×•× ×•×ª ×”×™×§×¨×™× ×ž×”×¨×‘ ×ž×™×›×œ ×•×™×©×¦×§×™ ×¢"×”.',
            'about-content-p2': '×›××Ÿ, ×ž×©×¤×—×”, ×—×‘×¨×™×, ×•×›×œ ××œ×” ×©×—×™×™×”× ×”×•×©×¤×¢×• ×ž×ž× ×• ×™×›×•×œ×™× ×œ×—×œ×•×§ ×ª×ž×•× ×•×ª, ×¡×¨×˜×•× ×™×, ×¡×™×¤×•×¨×™× ×•×–×™×›×¨×•× ×•×ª ×”×—×•×’×’×™× ××ª ×—×™×™×•, ×ª×•×¨×ª×•, ×•×”×©×¤×¢×ª×• ×¢×œ ×§×”×™×œ×ª× ×•.',
            'about-content-p3': '×›×œ ×–×™×›×¨×•×Ÿ ×”×ž×©×•×ª×£ ×›××Ÿ ×ª×•×¨× ×œ×©×ž×™×¨×ª ×ž×•×¨×©×ª×• ×—×™×” ×œ×“×•×¨×•×ª ×”×‘××™×.',
            'footer-text': '×œ×–×›×¨ ×”×¨×‘ ×ž×™×›×œ ×•×™×©×¦×§×™ ×¢"×”',
            'contact-text': '×™×¦×™×¨×ª ×§×©×¨: rebmichelvishedsky@gmail.com',
            'uploadvideo-title': '×”×¢×œ×” ×–×™×›×¨×•×Ÿ ×•×™×“××•',
            'uploadvideo-subtitle': '×©×ª×£ ×¡×¨×˜×•× ×™× ××¨×•×›×™× ×™×•×ª×¨ (×›×œ ×’×•×“×œ) ××™×ª× ×•. ×”×¡×¨×˜×•×Ÿ ×©×œ×š ×™×™×‘×“×§ ×œ×¤× ×™ ×©×™×•×¤×™×¢ ×‘××ª×¨.',
            'video-title-label': '×›×•×ª×¨×ª ×•×™×“××• *',
            'video-description-label': '×ª×™××•×¨',
            'video-submitter-label': '×©×ž×š (××•×¤×¦×™×•× ×œ×™)',
        }
    };

    let currentLanguage = 'en';
    let memories = [];
    let isAdmin = false;
    let availableTags = [];
    let currentEditingMemory = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordedBlob = null;
    let recordingTimer = null;
    let recordingSeconds = 0;
    let isPaused = false;
    let selectedVideoFile = null;

    // ============================================
    // CLOUDINARY UPLOAD FUNCTION
    // ============================================
    async function uploadToCloudinary(file, resourceType = 'auto') {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            formData.append('folder', 'memorial_site');

            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`;
            
            fetch(uploadUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.secure_url) {
                    resolve({
                        url: data.secure_url,
                        publicId: data.public_id,
                        format: data.format,
                        resourceType: data.resource_type
                    });
                } else {
                    reject(new Error('Upload failed'));
                }
            })
            .catch(error => reject(error));
        });
    }

    // ============================================
    // INITIALIZE FUNCTIONS
    // ============================================
    function initializeAirtableConfig() {
        const savedBaseId = localStorage.getItem('airtable_base_id');
        const savedApiKey = localStorage.getItem('airtable_api_key');
        
        if (savedBaseId) {
            AIRTABLE_CONFIG.baseId = savedBaseId;
            if (document.getElementById('base-id-input')) {
                document.getElementById('base-id-input').value = savedBaseId;
            }
        }
        
        if (savedApiKey) {
            AIRTABLE_CONFIG.apiKey = savedApiKey;
            if (document.getElementById('api-key-input')) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
        }
    }

    function saveAirtableConfig() {
        const baseId = document.getElementById('base-id-input').value.trim();
        const apiKey = document.getElementById('api-key-input').value.trim();
        
        if (!baseId || !apiKey) {
            showConfigStatus('Please enter both Base ID and API Key', 'error');
            return;
        }

        if (!baseId.startsWith('app')) {
            showConfigStatus('Base ID should start with "app"', 'error');
            return;
        }

        if (!apiKey.startsWith('pat')) {
            showConfigStatus('API Key should start with "pat"', 'error');
            return;
        }

        localStorage.setItem('airtable_base_id', baseId);
        localStorage.setItem('airtable_api_key', apiKey);
        
        AIRTABLE_CONFIG.baseId = baseId;
        AIRTABLE_CONFIG.apiKey = apiKey;
        
        showConfigStatus('Database configuration saved successfully!', 'success');
        testAirtableConnection();
    }

    async function testAirtableConnection() {
        if (!AIRTABLE_CONFIG.apiKey || !AIRTABLE_CONFIG.baseId) {
            showConfigStatus('Please save configuration first', 'error');
            return;
        }

        try {
            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}?maxRecords=1`,
                {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                    },
                }
            );

            if (response.ok) {
                showConfigStatus('Database connection successful!', 'success');
                await fetchMemoriesFromAirtable();
                refreshCurrentView();
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            showConfigStatus(`Connection failed: ${error.message}`, 'error');
        }
    }

    function showConfigStatus(message, type) {
        const statusDiv = document.getElementById('config-status');
        if (statusDiv) {
            statusDiv.innerHTML = `<div class="alert alert-${type}" style="margin-top: 10px;">${message}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }
    }

    async function initializeAirtable() {
        try {
            const response = await fetch('/api/get-config');
            if (response.ok) {
                const config = await response.json();
                AIRTABLE_CONFIG.apiKey = config.AIRTABLE_API_KEY;
                AIRTABLE_CONFIG.baseId = config.AIRTABLE_BASE_ID;
            } else {
                initializeAirtableConfig();
            }
        } catch (error) {
            console.warn('Could not load configuration from environment. Falling back to localStorage.');
            initializeAirtableConfig();
        }
    }

    // ============================================
    // AIRTABLE API FUNCTIONS
    // ============================================
    async function fetchMemoriesFromAirtable() {
        showLoading(true);
        try {
            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}?sort[0][field]=Created&sort[0][direction]=desc`,
                {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                    },
                }
            );

            if (!response.ok) {
                throw new Error(`Airtable API error: ${response.status}`);
            }

            const data = await response.json();
            memories = data.records.map(record => ({
                id: record.id,
                ...record.fields,
                timestamp: record.fields.Created || new Date().toISOString(),
                tags: record.fields.Tags ? record.fields.Tags.split(',').map(tag => tag.trim()) : []
            }));

            showLoading(false);
            return memories;
        } catch (error) {
            console.error('Error fetching memories:', error);
            showLoading(false);
            showAlert('Failed to load memories. Please check your internet connection.', 'error');
            return [];
        }
    }

    async function saveMemoryToAirtable(memoryData) {
        try {
            console.log('Sending to Airtable:', memoryData);
            
            const payload = {
                fields: {}
            };

            if (memoryData.title) payload.fields.Title = memoryData.title;
            if (memoryData.description) payload.fields.Description = memoryData.description;
            if (memoryData.type) payload.fields.Type = memoryData.type;
            if (memoryData.submitter) payload.fields.Submitter = memoryData.submitter;
            if (memoryData.email) payload.fields.Email = memoryData.email;
            if (memoryData.youtube) payload.fields.YouTube = memoryData.youtube;
            if (memoryData.cloudinaryUrl) payload.fields.CloudinaryURL = memoryData.cloudinaryUrl;
            if (memoryData.tags && memoryData.tags.length > 0) {
                payload.fields.Tags = memoryData.tags.join(', ');
            }

            console.log('Payload being sent:', JSON.stringify(payload, null, 2));

            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Airtable API Error Details:', errorData);
                throw new Error(`Airtable error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const newRecord = await response.json();
            console.log('Airtable response:', newRecord);
            
            return {
                id: newRecord.id,
                ...newRecord.fields,
                timestamp: newRecord.createdTime,
                tags: newRecord.fields.Tags ? newRecord.fields.Tags.split(',').map(tag => tag.trim()) : []
            };
        } catch (error) {
            console.error('Detailed error in saveMemoryToAirtable:', error);
            throw error;
        }
    }

    async function updateMemoryInAirtable(memoryId, updateData) {
        try {
            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${memoryId}`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fields: {
                            Title: updateData.title,
                            Description: updateData.description,
                            Tags: updateData.tags ? updateData.tags.join(', ') : ''
                        }
                    }),
                }
            );

            if (!response.ok) {
                throw new Error(`Failed to update memory: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Error updating memory:', error);
            throw error;
        }
    }

    async function deleteMemoryFromAirtable(memoryId) {
        try {
            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}/${memoryId}`,
                {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                    },
                }
            );

            if (!response.ok) {
                throw new Error(`Failed to delete memory: ${response.status}`);
            }

            return true;
        } catch (error) {
            console.error('Error deleting memory:', error);
            throw error;
        }
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    function showLoading(show) {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
            loadingEl.style.display = show ? 'block' : 'none';
        }
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        document.body.className = lang === 'he' ? 'hebrew' : '';
        document.body.dir = lang === 'he' ? 'rtl' : 'ltr';
        
        Object.keys(translations[lang]).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.tagName === 'INPUT' && element.type === 'text') {
                    element.placeholder = translations[lang][key];
                } else {
                    element.textContent = translations[lang][key];
                }
            }
        });

        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function showSection(section) {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById(section + '-section').style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navEl = document.getElementById('nav-' + section);
        if (navEl) navEl.classList.add('active');

        if (section === 'memories') {
            loadAllMemories();
        } else if (section === 'home') {
            loadRecentMemories();
        }
    }

    function getYouTubeEmbedId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|shorts\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // ============================================
    // FORM HANDLING
    // ============================================
    document.getElementById('memory-type').addEventListener('change', function() {
        const fileGroup = document.getElementById('file-group');
        const youtubeGroup = document.getElementById('youtube-group');
        const voiceGroup = document.getElementById('voice-group');

        fileGroup.style.display = 'none';
        youtubeGroup.style.display = 'none';
        voiceGroup.style.display = 'none';
        
        if (this.value === 'youtube') {
            fileGroup.style.display = 'none';
            youtubeGroup.style.display = 'block';
        } else if (this.value === 'voice') {
            voiceGroup.style.display = 'block';
        } else {
            fileGroup.style.display = 'block';
        }
    });

    document.getElementById('memory-file').addEventListener('change', function() {
        const fileName = this.files[0] ? this.files[0].name : 'Click to select or drag file here';
        document.getElementById('file-text').textContent = fileName;
    });

    // ============================================
    // FORM SUBMISSION WITH CLOUDINARY
    // ============================================
    document.getElementById('memory-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!AIRTABLE_CONFIG.apiKey) {
            showAlert('Database not configured. Please contact the administrator.', 'error');
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        const originalBtnText = submitBtn.textContent;
        submitBtn.textContent = 'Uploading...';
        submitBtn.disabled = true;

        try {
            const formData = new FormData(this);
            const memoryData = {
                type: formData.get('type'),
                title: formData.get('title'),
                description: formData.get('description'),
                youtube: formData.get('youtube'),
                submitter: formData.get('submitter') || '',
                email: formData.get('email') || '',
                tags: [],
                cloudinaryUrl: null
            };

            const fileInput = document.getElementById('memory-file');

            if (memoryData.type === 'youtube' && memoryData.youtube) {
                const newMemory = await saveMemoryToAirtable(memoryData);
                memories.unshift(newMemory);
                showAlert('Memory shared successfully!', 'success');
                resetForm();
                refreshCurrentView();
                
            } else if (memoryData.type === 'voice' && recordedBlob) {
                submitBtn.textContent = 'Uploading audio...';
                
                try {
                    const audioFile = new File([recordedBlob], `voice_${Date.now()}.wav`, { type: 'audio/wav' });
                    const uploadResult = await uploadToCloudinary(audioFile, 'video');
                    
                    memoryData.cloudinaryUrl = uploadResult.url;
                    memoryData.description += `\n\n[Voice Note: ${Math.floor(recordingSeconds/60)}:${(recordingSeconds%60).toString().padStart(2,'0')} duration]`;
                    
                    const newMemory = await saveMemoryToAirtable(memoryData);
                    memories.unshift(newMemory);
                    
                    showAlert('Voice note uploaded and shared successfully!', 'success');
                    resetForm();
                    refreshCurrentView();
                } catch (error) {
                    throw new Error('Failed to upload audio: ' + error.message);
                }
                
            } else if (fileInput.files[0] && memoryData.type !== 'youtube') {
                const file = fileInput.files[0];
                submitBtn.textContent = 'Uploading file...';
                
                try {
                    let resourceType = 'auto';
                    if (file.type.startsWith('image/')) {
                        resourceType = 'image';
                    } else if (file.type.startsWith('video/')) {
                        resourceType = 'video';
                    } else if (file.type.startsWith('audio/')) {
                        resourceType = 'video';
                    } else if (file.type === 'application/pdf' || memoryData.type === 'document') {
                        resourceType = 'raw';
                    }

                    const uploadResult = await uploadToCloudinary(file, resourceType);
                    memoryData.cloudinaryUrl = uploadResult.url;
                    
                    const newMemory = await saveMemoryToAirtable(memoryData);
                    memories.unshift(newMemory);
                    
                    showAlert('File uploaded and memory shared successfully!', 'success');
                    resetForm();
                    refreshCurrentView();
                } catch (error) {
                    throw new Error('Failed to upload file: ' + error.message);
                }
                
            } else {
                const newMemory = await saveMemoryToAirtable(memoryData);
                memories.unshift(newMemory);
                
                showAlert('Memory shared successfully!', 'success');
                resetForm();
                refreshCurrentView();
            }
            
        } catch (error) {
            console.error('Error submitting memory:', error);
            showAlert('Failed to submit memory: ' + error.message, 'error');
        } finally {
            submitBtn.textContent = originalBtnText;
            submitBtn.disabled = false;
        }
    });

    function resetForm() {
        document.getElementById('memory-form').reset();
        document.getElementById('file-text').textContent = 'Click to select or drag file here';
        document.getElementById('file-group').style.display = 'block';
        document.getElementById('youtube-group').style.display = 'none';
        document.getElementById('voice-group').style.display = 'none';
        
        recordedBlob = null;
        recordingSeconds = 0;
        document.getElementById('record-time').textContent = '0:00';
        document.getElementById('recorded-audio').style.display = 'none';
        document.getElementById('record-status').textContent = 'Click Start to begin recording';
    }

    function showAlert(message, type) {
        const alertDiv = document.getElementById('submission-alert');
        if (alertDiv) {
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }
    }

    function refreshCurrentView() {
        if (document.getElementById('home-section').style.display !== 'none') {
            loadRecentMemories();
        }
        if (document.getElementById('memories-section').style.display !== 'none') {
            loadAllMemories();
        }
    }

    function formatText(text) {
        if (!text) return '';
        return text
            .replace(/\*([^*]+)\*/g, '<strong>$1</strong>')
            .replace(/_([^_]+)_/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }

    // ============================================
    // MEMORY DISPLAY FUNCTIONS
    // ============================================
    function createMemoryCard(memory) {
        console.log('Creating card for memory:', memory);
        
        const date = new Date(memory.timestamp).toLocaleDateString();
        const tags = memory.tags || [];
        const title = memory.Title || memory.title || 'Untitled';
        
        let mediaHtml = '';
        
        if (memory.CloudinaryURL) {
            const url = memory.CloudinaryURL;
            if (url.includes('/image/')) {
                mediaHtml = `<img src="${url}" alt="${title}" class="memory-media">`;
            } else if (url.includes('/video/')) {
                if (memory.Type === 'voice' || memory.type === 'voice' || memory.Description?.includes('[Voice Note:') || url.match(/\.(mp3|wav|m4a|ogg|aac|flac)$/i)) {
                    mediaHtml = `<audio class="memory-media" controls style="width: 100%; height: 60px; background: var(--secondary-color);"><source src="${url}" type="audio/wav"></audio>`;
                } else {
                    mediaHtml = `<video class="memory-video" controls><source src="${url}"></video>`;
                }
            } else if (url.includes('.pdf') || url.includes('/raw/') || memory.Type === 'document' || memory.type === 'document') {
                const pdfId = 'pdf-' + memory.id;
                if (url.includes('/image/upload/') && url.includes('.pdf')) {
                    const imageUrl = url.replace('/image/upload/', '/image/upload/f_jpg,pg_1/').replace('.pdf', '.jpg');
                    mediaHtml = `
                        <div style="background: var(--secondary-color); padding: 20px; text-align: center;">
                            <img src="${imageUrl}" style="max-width: 100%; border: 1px solid var(--border-color); margin-bottom: 15px;" alt="PDF Preview">
                        </div>`;
                } else {
                    mediaHtml = `<div style="background: var(--secondary-color); padding: 20px; text-align: center;"><p>PDF Document</p></div>`;
                }
            }
        } else if (memory.Type === 'youtube' || memory.type === 'youtube') {
            const youtubeUrl = memory.YouTube || memory.youtube;
            console.log('YouTube URL found:', youtubeUrl);
            
            if (youtubeUrl) {
                const videoId = getYouTubeEmbedId(youtubeUrl);
                console.log('Video ID extracted:', videoId);
                
                if (videoId) {
                    mediaHtml = `<iframe class="memory-video" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            }
        } else if (memory.FileData && memory.FileType) {
            if (memory.FileType.startsWith('image/')) {
                mediaHtml = `<img src="${memory.FileData}" alt="${title}" class="memory-media">`;
            } else if (memory.FileType.startsWith('video/')) {
                mediaHtml = `<video class="memory-video" controls><source src="${memory.FileData}" type="${memory.FileType}"></video>`;
            } else if (memory.FileType.startsWith('audio/')) {
                mediaHtml = `<audio class="memory-media" controls style="width: 100%; height: 60px; background: var(--secondary-color);"><source src="${memory.FileData}" type="${memory.FileType}"></audio>`;
            }
        } else if (memory.Attachment && memory.Attachment.length > 0) {
            const attachment = memory.Attachment[0];
            if (attachment.type && attachment.type.startsWith('image/')) {
                mediaHtml = `<img src="${attachment.url}" alt="${title}" class="memory-media">`;
            } else if (attachment.type && attachment.type.startsWith('video/')) {
                mediaHtml = `<video class="memory-video" controls><source src="${attachment.url}" type="${attachment.type}"></video>`;
            } else if (attachment.type && attachment.type.startsWith('audio/')) {
                mediaHtml = `<audio class="memory-media" controls style="width: 100%; height: 60px; background: var(--secondary-color);"><source src="${attachment.url}" type="${attachment.type}"></audio>`;
            }
        }

        const tagsHtml = tags.map(tag => `<span class="tag" onclick="filterByTag('${tag}')">${tag}</span>`).join('');
        
        const description = formatText(memory.Description || memory.description || '');
        const submitter = memory.Submitter || memory.submitter || '';
        
        return `
            <div class="memory-card" onclick="openMemoryModal('${memory.id}')">
                ${mediaHtml}
                <div class="memory-content">
                    <h3 class="memory-title">${title}</h3>
                    ${description ? `<p class="memory-description">${description}</p>` : ''}
                    <div class="memory-meta">
                        ${submitter ? `<span>By: ${submitter}</span>` : ''}
                        <span>${date}</span>
                    </div>
                    ${tagsHtml ? `<div class="memory-tags">${tagsHtml}</div>` : ''}
                    <div class="memory-actions" style="display: ${isAdmin ? 'flex' : 'none'};">
                        <button class="btn btn-secondary btn-small" onclick="editMemory('${memory.id}', event)">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteMemory('${memory.id}', event)">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadRecentMemories() {
        if (memories.length === 0) {
            await fetchMemoriesFromAirtable();
        }

        const container = document.getElementById('recent-memories');
        if (!container) return;
        
        const recentMemories = memories.slice(0, 6);
        
        if (recentMemories.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--accent-color); grid-column: 1/-1;">No memories shared yet. Be the first to share a precious memory!</p>';
            return;
        }
        
        container.innerHTML = recentMemories.map(memory => createMemoryCard(memory)).join('');
    }

    async function loadAllMemories() {
        if (memories.length === 0) {
            await fetchMemoriesFromAirtable();
        }

        const container = document.getElementById('all-memories');
        if (!container) return;
        
        updateTagFilter();
        
        if (memories.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--accent-color); grid-column: 1/-1;">No memories shared yet.</p>';
            return;
        }
        
        container.innerHTML = memories.map(memory => createMemoryCard(memory)).join('');
    }

    function updateTagFilter() {
        const tagFilter = document.getElementById('tag-filter');
        if (!tagFilter) return;
        
        const allTags = [...new Set(memories.flatMap(memory => memory.tags || []))];
        
        tagFilter.innerHTML = '<option value="">All Categories</option>' + 
            allTags.map(tag => `<option value="${tag}">${tag}</option>`).join('');
    }

    function filterMemories() {
        const searchInput = document.getElementById('search-memories');
        const tagFilter = document.getElementById('tag-filter');
        
        if (!searchInput || !tagFilter) return;
        
        const searchTerm = searchInput.value.toLowerCase();
        const selectedTag = tagFilter.value;
        
        let filteredMemories = memories;
        
        if (searchTerm) {
            filteredMemories = filteredMemories.filter(memory =>
                (memory.Title || '').toLowerCase().includes(searchTerm) ||
                (memory.Description || '').toLowerCase().includes(searchTerm) ||
                (memory.Submitter || '').toLowerCase().includes(searchTerm)
            );
        }
        
        if (selectedTag) {
            filteredMemories = filteredMemories.filter(memory =>
                memory.tags && memory.tags.includes(selectedTag)
            );
        }
        
        const container = document.getElementById('all-memories');
        if (!container) return;
        
        if (filteredMemories.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--accent-color); grid-column: 1/-1;">No memories match your search criteria.</p>';
        } else {
            container.innerHTML = filteredMemories.map(memory => createMemoryCard(memory)).join('');
        }
    }

    const searchInput = document.getElementById('search-memories');
    const tagFilterEl = document.getElementById('tag-filter');
    if (searchInput) searchInput.addEventListener('input', filterMemories);
    if (tagFilterEl) tagFilterEl.addEventListener('change', filterMemories);

    function clearFilters() {
        const searchInput = document.getElementById('search-memories');
        const tagFilter = document.getElementById('tag-filter');
        
        if (searchInput) searchInput.value = '';
        if (tagFilter) tagFilter.value = '';
        
        loadAllMemories();
    }

    function filterByTag(tag) {
        if (document.getElementById('memories-section').style.display === 'none') {
            showSection('memories');
        }
        
        setTimeout(() => {
            const tagFilter = document.getElementById('tag-filter');
            if (tagFilter) {
                tagFilter.value = tag;
                filterMemories();
            }
        }, 100);
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openMemoryModal(memoryId) {
        const memory = memories.find(m => m.id === memoryId);
        if (!memory) return;
        
        console.log('Opening modal for memory:', memory);
        
        const modal = document.getElementById('memory-modal');
        const content = document.getElementById('modal-content');
        const title = memory.Title || memory.title || 'Untitled';
        
        let mediaHtml = '';
        
        if (memory.CloudinaryURL) {
            const url = memory.CloudinaryURL;
            if (url.includes('/image/')) {
                mediaHtml = `<img src="${url}" alt="${title}" style="width: 100%; max-height: 400px; object-fit: contain;">`;
            } else if (url.includes('/video/')) {
                if (memory.Type === 'voice' || memory.type === 'voice' || 
                    memory.Description?.includes('[Voice Note:') ||
                    url.match(/\.(mp3|wav|m4a|ogg|aac|flac)$/i)) {
                    mediaHtml = `<audio controls style="width: 100%;"><source src="${url}" type="audio/wav"></audio>`;
                } else {
                    mediaHtml = `<video width="100%" height="315" controls><source src="${url}"></video>`;
                }
            }
        } else if ((memory.Type === 'youtube' || memory.type === 'youtube')) {
            const youtubeUrl = memory.YouTube || memory.youtube;
            console.log('Modal YouTube URL:', youtubeUrl);
            
            if (youtubeUrl) {
                const videoId = getYouTubeEmbedId(youtubeUrl);
                console.log('Modal Video ID:', videoId);
                
                if (videoId) {
                    mediaHtml = `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            }
        } else if (memory.FileData && memory.FileType) {
            if (memory.FileType.startsWith('image/')) {
                mediaHtml = `<img src="${memory.FileData}" alt="${title}" style="width: 100%; max-height: 400px; object-fit: contain;">`;
            } else if (memory.FileType.startsWith('video/')) {
                mediaHtml = `<video width="100%" height="315" controls><source src="${memory.FileData}" type="${memory.FileType}"></video>`;
            } else if (memory.FileType.startsWith('audio/')) {
                mediaHtml = `<audio controls style="width: 100%;"><source src="${memory.FileData}" type="${memory.FileType}"></audio>`;
            }
        } else if (memory.Attachment && memory.Attachment.length > 0) {
            const attachment = memory.Attachment[0];
            if (attachment.type && attachment.type.startsWith('image/')) {
                mediaHtml = `<img src="${attachment.url}" alt="${title}" style="width: 100%; max-height: 400px; object-fit: contain;">`;
            } else if (attachment.type && attachment.type.startsWith('video/')) {
                mediaHtml = `<video width="100%" height="315" controls><source src="${attachment.url}" type="${attachment.type}"></video>`;
            } else if (attachment.type && attachment.type.startsWith('audio/')) {
                mediaHtml = `<audio controls style="width: 100%;"><source src="${attachment.url}" type="${attachment.type}"></audio>`;
            }
        }
        
        const date = new Date(memory.timestamp).toLocaleDateString();
        const tags = memory.tags || [];
        const tagsHtml = tags.map(tag => `<span class="tag">${tag}</span>`).join('');
        
        const description = formatText(memory.Description || memory.description || '');
        const submitter = memory.Submitter || memory.submitter || '';
        
        content.innerHTML = `
            ${mediaHtml}
            <h2 style="margin: 20px 0 10px 0;">${title}</h2>
            <p style="color: var(--accent-color); margin-bottom: 15px;">Shared by ${submitter} on ${date}</p>
            ${tagsHtml ? `<div style="margin-bottom: 15px;">${tagsHtml}</div>` : ''}
            <div style="line-height: 1.8;">${description}</div>
        `;
        
        modal.classList.add('show');
        window.currentMemoryId = memoryId;
    }

    function closeModal() {
        const modal = document.getElementById('memory-modal');
        if (modal) modal.classList.remove('show');
    }

    function shareCurrentMemory() {
        const memoryId = window.currentMemoryId;
        if (!memoryId) return;
        
        const url = `${window.location.origin}/memory/${memoryId}`;
        if (navigator.share) {
            navigator.share({
                title: 'Memorial Memory',
                url: url
            });
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }
    }

    // ============================================
    // ADMIN FUNCTIONS
    // ============================================
    function showAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel) panel.classList.add('show');
    }

    function adminLogin() {
        const password = document.getElementById('admin-password').value;
        if (password === 'admin123') {
            isAdmin = true;
            localStorage.setItem('isAdmin', 'true');
            document.getElementById('admin-login').style.display = 'none';
            document.getElementById('admin-dashboard').classList.add('show');
            
            initializeAirtableConfig();
            testAirtableConnection();
            
            updateAdminStats();
            loadExistingTags();
            refreshCurrentView();

            document.querySelectorAll('.memory-actions').forEach(actions => {
                actions.style.display = 'flex';
            });
        } else {
            alert('Incorrect password');
        }
    }

    function adminLogout() {
        isAdmin = false;
        localStorage.removeItem('isAdmin');
        const panel = document.getElementById('admin-panel');
        if (panel) panel.classList.remove('show');
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('admin-dashboard').classList.remove('show');
        document.getElementById('admin-password').value = '';
        refreshCurrentView();

        document.querySelectorAll('.memory-actions').forEach(actions => {
            actions.style.display = 'none';
        });
    }

    function updateAdminStats() {
        const totalEl = document.getElementById('total-memories');
        const tagsEl = document.getElementById('total-tags');
        const recentEl = document.getElementById('recent-submissions');
        
        if (totalEl) totalEl.textContent = memories.length;
        if (tagsEl) tagsEl.textContent = [...new Set(memories.flatMap(m => m.tags || []))].length;
        
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
        const recentCount = memories.filter(m => new Date(m.timestamp) > weekAgo).length;
        if (recentEl) recentEl.textContent = recentCount;
    }

    function loadExistingTags() {
        const container = document.getElementById('existing-tags');
        if (!container) return;
        
        const allTags = [...new Set(memories.flatMap(memory => memory.tags || []))];
        
        container.innerHTML = allTags.map(tag => `
            <div class="tag-removable">
                ${tag}
                <button class="tag-remove-btn" onclick="removeTag('${tag}')">Ã—</button>
            </div>
        `).join('');
    }

    async function editMemory(memoryId, event) {
        event.stopPropagation();
        const memory = memories.find(m => m.id === memoryId);
        if (!memory) return;
        
        currentEditingMemory = memory;
        document.getElementById('edit-title').value = memory.Title;
        document.getElementById('edit-description').value = memory.Description;
        document.getElementById('edit-tags').value = (memory.tags || []).join(', ');
        
        document.getElementById('edit-modal').classList.add('show');
    }

    async function deleteMemory(memoryId, event) {
        event.stopPropagation();
        if (confirm('Are you sure you want to delete this memory?')) {
            try {
                await deleteMemoryFromAirtable(memoryId);
                memories = memories.filter(m => m.id !== memoryId);
                
                refreshCurrentView();
                updateAdminStats();
            } catch (error) {
                showAlert('Failed to delete memory. Please try again.', 'error');
            }
        }
    }

    document.getElementById('edit-memory-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!currentEditingMemory) return;
        
        try {
            const updateData = {
                title: document.getElementById('edit-title').value,
                description: document.getElementById('edit-description').value,
                tags: document.getElementById('edit-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };

            await updateMemoryInAirtable(currentEditingMemory.id, updateData);
            
            currentEditingMemory.Title = updateData.title;
            currentEditingMemory.Description = updateData.description;
            currentEditingMemory.tags = updateData.tags;
            
            closeEditModal();
            refreshCurrentView();
            loadExistingTags();
        } catch (error) {
            showAlert('Failed to update memory. Please try again.', 'error');
        }
    });

    function closeEditModal() {
        const modal = document.getElementById('edit-modal');
        if (modal) modal.classList.remove('show');
        currentEditingMemory = null;
    }

    function exportData() {
        const dataStr = JSON.stringify(memories, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'memorial-memories.json';
        link.click();
    }

    async function clearAllData() {
        if (confirm('Are you sure you want to delete ALL memories? This cannot be undone.')) {
            alert('For safety, please delete memories individually or contact support for bulk deletion.');
        }
    }

    // ============================================
    // VOICE RECORDING
    // ============================================
    function initializeVoiceRecording() {
        const startBtn = document.getElementById('start-record');
        const pauseBtn = document.getElementById('pause-record');
        const stopBtn = document.getElementById('stop-record');
        const playBtn = document.getElementById('play-record');
        const statusText = document.getElementById('record-status');
        const timeDisplay = document.getElementById('record-time');
        const audioElement = document.getElementById('recorded-audio');

        if (!startBtn || !pauseBtn || !stopBtn || !playBtn) return;

        startBtn.addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                recordingSeconds = 0;
        
                mediaRecorder = new MediaRecorder(stream);
        
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
        
                mediaRecorder.onstop = function() {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(recordedBlob);
                    audioElement.src = audioUrl;
                    audioElement.style.display = 'block';
            
                    stream.getTracks().forEach(track => track.stop());
                };
        
                mediaRecorder.start();
        
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                statusText.textContent = 'Recording...';
        
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
        
            } catch (error) {
                statusText.textContent = 'Error: Could not access microphone';
            }
        });

        pauseBtn.addEventListener('click', function() {
            if (mediaRecorder && !isPaused) {
                mediaRecorder.pause();
                isPaused = true;
                pauseBtn.textContent = 'Resume';
                statusText.textContent = 'Recording paused';
                clearInterval(recordingTimer);
            } else if (mediaRecorder && isPaused) {
                mediaRecorder.resume();
                isPaused = false;
                pauseBtn.textContent = 'Pause';
                statusText.textContent = 'Recording...';
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }
        });

        stopBtn.addEventListener('click', function() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                clearInterval(recordingTimer);

                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                playBtn.disabled = false;
                statusText.textContent = 'Recording complete. Click Play to review.';
                isPaused = false;
                pauseBtn.textContent = 'Pause';
            }
        });

        playBtn.addEventListener('click', function() {
            if (audioElement.src) {
                audioElement.play();
            }
        });
    }

    // ============================================
    // GOFILE VIDEO UPLOAD SYSTEM
    // ============================================

    function initializeVideoUpload() {
        const dropZone = document.getElementById('videoDropZone');
        const fileInput = document.getElementById('videoFileInput');
        const cancelBtn = document.getElementById('cancelVideoBtn');
        const submitBtn = document.getElementById('submitVideoBtn');

        if (!dropZone || !fileInput) return;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                handleVideoSelection(file);
            } else {
                showVideoAlert('Please select a video file', 'error');
            }
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleVideoSelection(file);
            }
        });

        if (cancelBtn) {
            cancelBtn.addEventListener('click', resetVideoUpload);
        }

        if (submitBtn) {
            submitBtn.addEventListener('click', submitVideoToGoFile);
        }
    }

    function handleVideoSelection(file) {
        selectedVideoFile = file;
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        
        document.getElementById('drop-text').textContent = file.name;
        document.getElementById('drop-subtext').textContent = `Size: ${fileSizeMB} MB`;
        
        document.getElementById('videoMetadataForm').style.display = 'block';
        
        showVideoAlert(`Video selected: ${file.name} (${fileSizeMB} MB)`, 'success');
    }

    function resetVideoUpload() {
        selectedVideoFile = null;
        document.getElementById('videoFileInput').value = '';
        document.getElementById('video-title').value = '';
        document.getElementById('video-description').value = '';
        document.getElementById('video-submitter').value = '';
        document.getElementById('videoMetadataForm').style.display = 'none';
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('drop-text').textContent = 'Drag video here or click to select';
        document.getElementById('drop-subtext').textContent = 'Any video size accepted â€¢ MP4, MOV, AVI, etc.';
        document.getElementById('upload-alert').innerHTML = '';
    }

    async function submitVideoToGoFile() {
        if (!selectedVideoFile) {
            showVideoAlert('Please select a video first', 'error');
            return;
        }

        const title = document.getElementById('video-title').value.trim();
        if (!title) {
            showVideoAlert('Please enter a video title', 'error');
            return;
        }

        const description = document.getElementById('video-description').value.trim();
        const submitter = document.getElementById('video-submitter').value.trim() || 'Anonymous';

        const submitBtn = document.getElementById('submitVideoBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';

        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('videoMetadataForm').style.display = 'none';

        try {
            updateUploadStatus('Preparing upload...', 5);
            const serverResponse = await fetch('/api/upload-video', { method: 'POST' });
            const configData = await configResponse.json();
            
            if (configData.status !== 'ok') {
                throw new Error('Failed to prepare upload: ' + (configData.error || 'Unknown error'));
            }

            const { token, folderId, uploadUrl } = configData;
            updateUploadStatus('Uploading to server...', 10);

            const formData = new FormData();
            formData.append('file', selectedVideoFile);
            formData.append('token', token);
            formData.append('folderId', folderId);

            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 80) + 10;
                    updateUploadStatus(`Uploading video... ${percentComplete}%`, percentComplete);
                }
            });

            xhr.addEventListener('load', async function() {
                if (xhr.status === 200) {
                    try {
                        const uploadData = JSON.parse(xhr.responseText);

                        if (uploadData.status === 'ok' && uploadData.data) {
                            updateUploadStatus('Saving to database...', 95);
                            const fileData = uploadData.data;
                            const downloadLink = fileData.directLink || fileData.downloadPage || `https://gofile.io/d/${fileData.code}`;

                            await saveVideoToAirtable({
                                title: title,
                                description: description,
                                submitter: submitter,
                                gofileUrl: downloadLink,
                                fileName: selectedVideoFile.name,
                                fileSize: (selectedVideoFile.size / (1024 * 1024)).toFixed(2) + ' MB'
                            });

                            updateUploadStatus('Upload complete!', 100);
                            showVideoAlert('Video uploaded successfully! It will be reviewed and added to the site soon.', 'success');

                            setTimeout(resetVideoUpload, 3000);
                        } else {
                            throw new Error('Upload failed: ' + (uploadData.status || 'Unknown error'));
                        }
                    } catch (parseError) {
                        throw new Error('Invalid upload response: ' + parseError.message);
                    }
                } else {
                    throw new Error('Upload failed with status: ' + xhr.status);
                }
            });

            xhr.addEventListener('error', function() {
                throw new Error('Network error during upload');
            });

            xhr.open('POST', uploadUrl);
            xhr.send(formData);

        } catch (error) {
            console.error('Upload error:', error);
            showVideoAlert('Upload failed: ' + error.message, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Video';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('videoMetadataForm').style.display = 'block';
        }
    }

    async function saveVideoToAirtable(videoData) {
        try {
            const payload = {
                fields: {
                    Title: videoData.title,
                    Description: videoData.description || '',
                    Submitter: videoData.submitter,
                    Type: 'video',
                    GoFileURL: videoData.gofileUrl,
                    Status: 'Pending Review'
                }
            };

            const response = await fetch(
                `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                }
            );

            if (!response.ok) {
                throw new Error('Failed to save to database');
            }

            const newRecord = await response.json();
            console.log('Video saved to Airtable:', newRecord);
            console.log('Download from:', videoData.gofileUrl);
            console.log('Title:', videoData.title);
            console.log('Submitted by:', videoData.submitter);

            return newRecord;
        } catch (error) {
            console.error('Airtable save error:', error);
            throw error;
        }
    }

    function updateUploadStatus(message, percent) {
        document.getElementById('uploadStatus').textContent = message;
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressFill').textContent = percent + '%';
    }

    function showVideoAlert(message, type) {
        const alertDiv = document.getElementById('upload-alert');
        alertDiv.innerHTML = `<div class="alert alert-${type}" style="margin-bottom: 20px;">${message}</div>`;
        
        setTimeout(() => {
            alertDiv.innerHTML = '';
        }, 5000);
    }

    // Placeholder tag functions
    function addTag() {
        alert('Tag management will be implemented with Airtable integration.');
    }

    function removeTag(tag) {
        alert('Tag removal will be implemented with Airtable integration.');
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
        await initializeAirtable();
        initializeVoiceRecording();
        initializeVideoUpload();
        
        if (localStorage.getItem('isAdmin') === 'true') {
            isAdmin = true;
        }

        showSection('home');
    });

    const memoryModal = document.getElementById('memory-modal');
    const editModal = document.getElementById('edit-modal');
    
    if (memoryModal) {
        memoryModal.addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    }

    if (editModal) {
        editModal.addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
    }

    const tagInput = document.getElementById('new-tag-input');
    if (tagInput) {
        tagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        });
    }
    </script>
</body>
</html>
